<!DOCTYPE html>
<html lang="es-CL">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartera Cliente: revisi√≥n y propuesta V_octubre2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        /* --- Estilos Generales y Paleta BCI --- */
        :root {
            --bci-azul-oscuro: #002D5A;
            --bci-azul-medio: #005FFF;
            --bci-gris-claro: #f4f8ff;
            --bci-gris-borde: #daddf0;
            --color-sell: #D00000;
            --color-buy: #018749;
            --color-new-buy: #005FFF;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0 auto;
            padding: 10px 20px;
            max-width: 1200px;
            background-color: #f9f9f9;
            color: #333;
        }

        h1, h2, h3, h4 {
            color: var(--bci-azul-oscuro);
            margin-top: 1.5em;
        }

        h1 {
            text-align: center;
            border-bottom: 4px solid var(--bci-azul-medio);
            padding-bottom: 10px;
        }

        h2 {
            border-bottom: 2px solid var(--bci-azul-medio);
            padding-bottom: 5px;
            margin-top: 2em;
        }

        h3 {
            border-bottom: 1px solid var(--bci-gris-borde);
            padding-bottom: 3px;
        }

        /* --- Estilos de Tablas --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.95em;
        }

        th, td {
            border: 1px solid var(--bci-gris-borde);
            padding: 10px 12px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: var(--bci-azul-oscuro);
            color: white;
            font-weight: bold;
        }

        tbody tr:nth-child(odd) {
            background-color: #fff;
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--bci-gris-claro);
        }
        
        tfoot tr {
            background-color: #e9ecef;
            font-weight: bold;
        }

        td.text-right, th.text-right { text-align: right; }
        td.text-center, th.text-center { text-align: center; }

        /* Clases de color para ajustes */
        .sell { color: var(--color-sell); font-weight: bold; }
        .buy { color: var(--color-buy); font-weight: bold; }
        .new-buy { color: var(--bci-azul-medio); font-weight: bold; }
        .portfolio-row,
        tr.portfolio-row:nth-child(odd),
        tr.portfolio-row:nth-child(even) {
            background-color: #e6eefc;
            font-weight: bold;
        }
        .portfolio-detail-row,
        tr.portfolio-detail-row:nth-child(odd),
        tr.portfolio-detail-row:nth-child(even) {
            background-color: #f4f8ff;
            font-size: 0.9em;
        }
        .portfolio-detail-row td {
            padding-left: 30px;
        }
        .caja-row,
        tr.caja-row:nth-child(odd),
        tr.caja-row:nth-child(even) {
            background-color: #fef8e0;
            font-style: italic;
        }


        /* --- Estilos de Controles e Inputs --- */
        input[type="number"] {
            width: 120px;
            padding: 8px;
            border: 1px solid var(--bci-gris-borde);
            border-radius: 4px;
            text-align: right;
            font-size: 1em;
            margin-right: 5px;
        }
        
        #tabla-ponderacion-acciones input[type="number"] {
            width: 80px;
            padding: 5px;
            font-size: 0.95em;
        }

        input[type="radio"], input[type="checkbox"] {
            margin-right: 5px;
            transform: scale(1.1);
            vertical-align: middle;
        }

        .decision-label {
            margin-right: 15px;
            cursor: pointer;
        }
        
        .monto-parcial-input {
            width: 100px;
            margin-left: 5px;
        }

        #capital-total-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bci-gris-claro);
            border: 1px solid var(--bci-gris-borde);
            border-radius: 5px;
            font-size: 1.2em;
            text-align: right;
        }
        
        #capital-liberado-monto {
            color: var(--color-buy);
            font-weight: bold;
        }

        #capital-warning {
            color: var(--color-sell);
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        #modelo-toggle-container {
            margin-top: 15px;
            padding: 12px;
            background-color: #fff;
            border: 1px solid var(--bci-gris-borde);
            border-radius: 5px 5px 0 0;
            font-size: 1.05em;
            border-bottom: none;
        }
        #modelo-toggle-container label {
            font-weight: bold;
            color: var(--bci-azul-oscuro);
            cursor: pointer;
        }
        #capital-para-acciones-monto {
            color: var(--color-buy);
            font-weight: bold;
        }
        
        #ponderacion-acciones-container {
            margin-top: 0;
            border: 1px solid var(--bci-gris-borde);
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background-color: #fff;
        }
        #total-ponderacion-pct.invalid {
            color: var(--color-sell);
            font-weight: bold;
        }
        
        /* --- Secci√≥n 1.5: Selecci√≥n de Estrategia --- */
        #strategy-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .strategy-button {
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid var(--bci-gris-borde);
            background-color: #fff;
            color: var(--bci-azul-medio);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .strategy-button:hover {
            background-color: var(--bci-gris-claro);
            border-color: var(--bci-azul-medio);
        }
        .strategy-button.active {
            background-color: var(--bci-azul-oscuro);
            color: white;
            border-color: var(--bci-azul-oscuro);
        }

        /* --- Secci√≥n 2: An√°lisis de Activos Clave --- */
        #analisis-dinamico-container .analysis-container {
            margin-top: 15px;
            border: 1px solid var(--bci-gris-borde);
            border-radius: 5px;
            background-color: #fff;
            padding: 20px;
        }
        .analysis-box {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .analysis-justificacion {
            flex: 2;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .analysis-drivers {
            flex: 1;
        }
        .drivers-box {
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .drivers-box h5 {
            margin-top: 0;
            padding-bottom: 5px;
            font-size: 1.1em;
        }
        .drivers-box ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .drivers-positivo {
            background-color: #e6f4e9;
            border: 1px solid #c3e6cb;
        }
        .drivers-positivo h5 { color: #155724; border-bottom: 1px solid #b1dfbb; }
        .drivers-negativo {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            margin-top: 10px;
        }
        .drivers-negativo h5 { color: #721c24; border-bottom: 1px solid #f1b0b7; }
        .analysis-table {
            width: 100%;
            margin-bottom: 15px;
        }
        cite {
            font-size: 0.8em;
            color: #777;
            font-style: italic;
        }

        /* --- Secci√≥n 3: Portafolios --- */
        #adp-info-display {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px dashed var(--bci-gris-borde);
            border-radius: 5px;
            font-size: 0.9em;
            min-height: 50px;
        }
        #adp-info-display p { margin: 5px 0 0 0; }
        #adp-info-display strong { color: var(--bci-azul-oscuro); }

        /* --- Secci√≥n 5: Resumen Ejecutivo --- */
        #resumen-ejecutivo {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 30px;
            margin-top: 20px;
        }
        #print-button {
            float: right;
            padding: 10px 15px;
            background-color: var(--bci-azul-medio);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #print-button:hover {
            background-color: var(--bci-azul-oscuro);
        }
        .origen-destino-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }
        .origen-destino-col {
            flex: 1;
            padding: 15px;
            border: 1px solid var(--bci-gris-borde);
            border-radius: 5px;
            background-color: var(--bci-gris-claro);
        }
        .origen-destino-col h4 {
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--bci-gris-borde);
        }
        .origen-destino-col ul {
            padding-left: 20px;
            margin: 0;
        }
        .origen-destino-col li {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            margin-bottom: 5px;
        }
        .origen-destino-col .total {
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
        }

        .charts-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-box {
            flex: 1;
            position: relative;
            height: 350px; /* Ajustar altura para gr√°ficos */
        }
        #ejecutivo-tabla-final {
            margin-top: 25px;
        }

        /* --- Estilos de Impresi√≥n --- */
        @media print {
            body * {
                visibility: hidden;
            }
            #resumen-ejecutivo, #resumen-ejecutivo * {
                visibility: visible;
            }
            #resumen-ejecutivo {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            #print-button {
                visibility: hidden;
            }
            .charts-container {
                page-break-inside: avoid;
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>

    <h1>Simulador de Rebalanceo de Cartera</h1>
    <p><strong>Asesor:</strong> Cartera Cliente: revisi√≥n y propuesta V_octubre2025 (Equipo Estrategia BCI)</p>
    <p>Esta herramienta le permite simular el rebalanceo de su cartera. Puede decidir vender sus activos actuales, aportar nuevo capital, e invertir en portafolios recomendados o en una nueva mezcla de acciones individuales.</p>

    <h2>1. Simulador de Rebalanceo y Aporte de Capital</h2>
    <p>Revise su cartera actual y decida qu√© activos desea vender (total o parcialmente). Luego, ingrese el monto de capital nuevo que desea aportar.</p>
    
    <table id="tabla-desinversion">
        <thead>
            <tr>
                <th>Sector</th>
                <th>Activo Actual</th>
                <th class="text-right">Monto Actual (CLP)</th>
                <th class="text-center" style="width: 45%;">Decisi√≥n de Venta</th>
                <th class="text-right">Monto a Liberar (CLP)</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="capital-total-container">
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
            <label for="aporte-capital-nuevo"><strong>Aporte de Capital Nuevo (CLP):</strong></label>
            <input type="number" id="aporte-capital-nuevo" value="0" min="0" step="1000000">
        </div>
        <hr style="border: 0; border-top: 1px solid var(--bci-gris-borde); margin: 15px 0;">
        <div style="font-size: 1.3em;">
            <strong>Capital Total Disponible para Invertir: <span id="capital-liberado-monto">$0</span></strong>
        </div>
    </div>

    <h2>1.5. Selecci√≥n de Estrategia de Acciones</h2>
    <p>Por favor, seleccione el perfil de estrategia para la inversi√≥n en acciones individuales. Esto definir√° el an√°lisis de la Secci√≥n 2 y el destino del capital restante.</p>
    <div id="strategy-selector">
        </div>


    <h2>2. An√°lisis de Activos Clave</h2>
    <div id="analisis-dinamico-container">
        </div>


    <h2>3. Incorporar Portafolios Accionarios Bci</h2>
    <p>Seleccione los portafolios administrados en los que desea invertir e ingrese el monto en CLP para cada uno. El monto total no puede superar su capital disponible.</p>

    <table id="tabla-portafolios">
        <thead>
            <tr>
                <th style="width: 5%;">Selec.</th>
                <th>Portafolio Administrado</th>
                <th>Perfil de Riesgo</th>
                <th class="text-right">YTD</th>
                <th class="text-right" style="width: 25%;">Monto a Invertir (CLP)</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    <div id="capital-warning" style="display: none;">
        (!) El monto asignado a portafolios supera el capital disponible. Se ha ajustado al m√°ximo.
    </div>

    <div id="modelo-toggle-container">
        <label>
            <input type="checkbox" id="toggle-modelo-acciones" checked> 
            Invertir capital restante (<span id="capital-para-acciones-monto">$0</span>) en el Modelo de Acciones Recomendado.
        </label>
        <p style="font-size: 0.8em; margin: 5px 0 0 25px; font-weight: normal; color: #333;">
            (Si desmarca esta casilla, el capital restante quedar√° como "Caja (No Asignado)")
        </p>
    </div>
    
    <div id="ponderacion-acciones-container" style="display: none;">
        <h4 style="margin-top:0;">Personalizar Ponderaci√≥n del Modelo</h4>
        <p style="font-size: 0.9em; margin-top: -10px;">Ajuste los pesos (%) de las acciones recomendadas. El total debe sumar 100%.</p>
        <table id="tabla-ponderacion-acciones">
            <thead>
                <tr>
                    <th>Activo</th>
                    <th>Categor√≠a/Sector</th>
                    <th class="text-right">Ponderaci√≥n (%)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" class="text-right"><strong>Total Ponderado</strong></td>
                    <td class="text-right"><strong id="total-ponderacion-pct">100,0%</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div id="adp-info-display">
        <p>Seleccione un portafolio para ver su descripci√≥n y composici√≥n principal.</p>
    </div>

    <h2>4. Propuesta de Rebalanceo a Ejecutar</h2>
    <p>Este es el detalle de las operaciones de venta, mantenci√≥n y compra que se ejecutar√≠an seg√∫n sus decisiones.</p>

    <h3>Rebalanceo de Acciones Individuales</h3>
    <table id="tabla-final-acciones">
        <thead>
            <tr>
                <th>Categor√≠a/Sector</th>
                <th>Activo</th>
                <th class="text-right">Monto Actual (CLP)</th>
                <th class="text-right">Ajuste (CLP)</th>
                <th class="text-right">Ajuste (%)</th>
                <th class="text-right">Monto Objetivo (CLP)</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <h3>Inversi√≥n en Portafolios Accionarios Bci</h3>
    <table id="tabla-final-adp">
        <thead>
            <tr>
                <th>Categor√≠a/Sector</th>
                <th>Activo/Portafolio</th>
                <th class="text-right">Monto Actual (CLP)</th>
                <th class="text-right">Ajuste (CLP)</th>
                <th class="text-right">Ajuste (%)</th>
                <th class="text-right">Monto Objetivo (CLP)</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>


    <div id="resumen-ejecutivo">
        <h2>5. Resumen Ejecutivo de la Propuesta Final</h2>
        <button id="print-button" onclick="window.print()">üñ®Ô∏è Imprimir Resumen</button>

        <h3>Visi√≥n de Mercado y Objetivo</h3>
        <p>
            Nuestro escenario base contempla para 2026 un crecimiento del PIB de 2,1%, una inflaci√≥n controlada en torno al 3,0% y una Tasa de Pol√≠tica Monetaria estabiliz√°ndose en 4,0%. Este ambiente de normalizaci√≥n, junto a un precio del cobre resiliente ($4,3 USD/lb) y un tipo de cambio en $910, deber√≠a impulsar los resultados corporativos.
            <br>
            Proyectamos que el **IPSA alcanzar√≠a en torno a 10.250 puntos durante 2026**. El objetivo de esta propuesta es alinear su cartera a esta visi√≥n, capturando oportunidades en sectores con mayor retorno esperado y gestionando el riesgo mediante la diversificaci√≥n en portafolios administrados y acciones seleccionadas por su perfil t√°ctico y fundamental.
        </p>

        <h3>Origen y Destino de Fondos</h3>
        <div class="origen-destino-container">
            <div class="origen-destino-col">
                <h4>Origen de Fondos (CLP)</h4>
                <ul id="origen-fondos">
                    </ul>
            </div>
            <div class="origen-destino-col">
                <h4>Destino de Fondos (CLP)</h4>
                <ul id="destino-fondos">
                    </ul>
            </div>
        </div>

        <h3>Composici√≥n de Cartera</h3>
        <div class="charts-container">
            <div class="chart-box">
                <h4>Cartera Actual</h4>
                <canvas id="grafico-actual"></canvas>
            </div>
            <div class="chart-box">
                <h4>Cartera Objetivo Total</h4>
                <canvas id="grafico-objetivo"></canvas>
            </div>
        </div>

        <h3>Detalle Cartera Objetivo</h3>
        <table id="ejecutivo-tabla-final">
            <thead>
                <tr>
                    <th>Categor√≠a/Sector</th>
                    <th>Activo/Portafolio</th>
                    <th class="text-right">Monto Objetivo (CLP)</th>
                    <th class="text-right">% Cartera</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
            <tfoot>
                </tfoot>
        </table>
    </div>

    <script>
        // ===================================================================
        // SCRIPT DE DATOS Y L√ìGICA DEL SIMULADOR
        // ===================================================================

        // --- 1. DEFINICI√ìN DE DATOS ---

        // INPUT 1: Cartera Actual del Cliente (Cliente desde Cero)
        const carteraActual = [];

        // INPUT 2: Datos de Portafolios Accionarios Bci (usados para Sec 3 y Sec 1.5)
        const portafoliosBCI = {
            "tactico": {
                id: "tactico",
                nombre: "Portafolio T√°ctico",
                perfil: "Agresivo",
                ytd: 51.9,
                descripcion: "Dise√±ado para capturar valor de forma activa frente a oportunidades de corto y mediano plazo, con gesti√≥n flexible.",
                composicion: [
                    { activo: "BSANTANDER", peso: 0.20, sector: "Bancario", categoria: "Bancos" },
                    { activo: "LTM", peso: 0.20, sector: "Transporte", categoria: "Transportes" },
                    { activo: "ANDINA-B", peso: 0.10, sector: "Bebidas", categoria: "Bebidas" },
                    { activo: "AGUAS-A", peso: 0.10, sector: "Sanitario", categoria: "Sanitarias" },
                    { activo: "CHILE", peso: 0.10, sector: "Bancario", categoria: "Bancos" },
                    { activo: "SQM-B", peso: 0.10, sector: "Commodities", categoria: "Commodities" },
                    { activo: "CENCOSUD", peso: 0.075, sector: "Retail", categoria: "Retail" },
                    { activo: "FALABELLA", peso: 0.075, sector: "Retail", categoria: "Retail" },
                    { activo: "MALLPLAZA", peso: 0.05, sector: "Inmobiliario", categoria: "Inm. Comercial" }
                ]
            },
            "fundamental": {
                id: "fundamental",
                nombre: "Portafolio Fundamental",
                perfil: "Agresivo",
                ytd: 44.5,
                descripcion: "Dise√±ado para maximizar rentabilidad a trav√©s de ganancias de capital con visi√≥n de mediano a largo plazo, basado en fundamentos s√≥lidos.",
                composicion: [
                    { activo: "BSANTANDER", peso: 0.20, sector: "Bancario", categoria: "Bancos" },
                    { activo: "LTM", peso: 0.20, sector: "Transporte", categoria: "Transportes" },
                    { activo: "CENCOMALLS", peso: 0.175, sector: "Inmobiliario", categoria: "Inm. Comercial" },
                    { activo: "ENELCHILE", peso: 0.15, sector: "El√©ctrico", categoria: "El√©ctricas" },
                    { activo: "SQM-B", peso: 0.125, sector: "Commodities", categoria: "Commodities" },
                    { activo: "CENCOSUD", peso: 0.10, sector: "Retail", categoria: "Retail" },
                    { activo: "FALABELLA", peso: 0.05, sector: "Retail", categoria: "Retail" }
                ]
            },
            "dividendos": {
                id: "dividendos",
                nombre: "Portafolio Dividendos",
                perfil: "Moderado",
                ytd: 41.3,
                descripcion: "Objetivo principal es obtener retornos v√≠a reparto de dividendos, con un beta relativamente bajo.",
                composicion: [
                    { activo: "BSANTANDER", peso: 0.25, sector: "Bancario", categoria: "Bancos" },
                    { activo: "CENCOMALLS", peso: 0.15, sector: "Inmobiliario", categoria: "Inm. Comercial" },
                    { activo: "AGUAS-A", peso: 0.15, sector: "Sanitario", categoria: "Sanitarias" },
                    { activo: "ENELCHILE", peso: 0.10, sector: "El√©ctrico", categoria: "El√©ctricas" },
                    { activo: "COLBUN", peso: 0.10, sector: "El√©ctrico", categoria: "El√©ctricas" },
                    { activo: "CHILE", peso: 0.10, sector: "Bancario", categoria: "Bancos" },
                    { activo: "ANDINA-B", peso: 0.10, sector: "Bebidas", categoria: "Bebidas" },
                    { activo: "VAPORES", peso: 0.05, sector: "Transporte", categoria: "Transportes" }
                ]
            },
            "esg": {
                id: "esg",
                nombre: "Portafolio ESG",
                perfil: "Agresivo",
                ytd: 44.7,
                descripcion: "Busca alinear objetivos de rentabilidad con una visi√≥n de sostenibilidad, invirtiendo en compa√±√≠as con compromiso comprobable ASG.",
                composicion: [
                    { activo: "BSANTANDER", peso: 0.25, sector: "Bancario", categoria: "Bancos" },
                    { activo: "PARAUCO", peso: 0.25, sector: "Inmobiliario", categoria: "Inm. Comercial" },
                    { activo: "LTM", peso: 0.20, sector: "Transporte", categoria: "Transportes" },
                    { activo: "ENELCHILE", peso: 0.10, sector: "El√©ctrico", categoria: "El√©ctricas" },
                    { activo: "CENCOSUD", peso: 0.10, sector: "Retail", categoria: "Retail" },
                    { activo: "SMU", peso: 0.05, sector: "Retail", categoria: "Retail" },
                    { activo: "CMPC", peso: 0.05, sector: "Forestal", categoria: "Forestal" }
                ]
            },
            "eeuu": {
                id: "eeuu",
                nombre: "Portafolio Acciones EE.UU. (CLP)",
                perfil: "Agresivo",
                ytd: 16.7,
                descripcion: "Exposici√≥n directa al mercado estadounidense (acciones listadas en bolsa local) para superar al S&P 500.",
                composicion: [
                    { activo: "VISA (VCL)", peso: 0.20, sector: "Tecnolog√≠a", categoria: "Tecnolog√≠a" },
                    { activo: "ELI LILLY (LLYCL)", peso: 0.15, sector: "Salud", categoria: "Salud" },
                    { activo: "AMAZON (AMZNCL)", peso: 0.15, sector: "Consumo Discrecional", categoria: "Consumo" },
                    { activo: "MICROSOFT (MSFTCL)", peso: 0.10, sector: "Tecnolog√≠a", categoria: "Tecnolog√≠a" },
                    { activo: "META (METACL)", peso: 0.10, sector: "Comunicaciones", categoria: "Comunicaciones" },
                    { activo: "NEWMONT (NEMCL)", peso: 0.10, sector: "Materiales", categoria: "Commodities" },
                    { activo: "ORACLE (ORCLCL)", peso: 0.10, sector: "Tecnolog√≠a", categoria: "Tecnolog√≠a" },
                    { activo: "NVIDIA (NVDACL)", peso: 0.05, sector: "Tecnolog√≠a", categoria: "Tecnolog√≠a" }
                ]
            }
        };

        // INPUT 3: "Database" de An√°lisis Fundamental (Secci√≥n 2 Din√°mica)
        const analisisActivosClave = {
            'BSANTANDER': {
                nombre: 'Banco Santander (BSANTANDER)',
                recomendacion: 'Neutral',
                precioObjetivo: '$ 68 / acci√≥n',
                retorno: '13,2%',
                fuente: 'Booklet 2026',
                tesis: 'Proyectamos que el Margen de Inter√©s Neto (NIM) ser√° el principal motor de los resultados financieros. Esta expansi√≥n se fundamenta en una continua moderaci√≥n del costo de fondeo en un escenario de tasas m√°s favorable. Esperamos que el margen bruto crezca, catalizando una robusta expansi√≥n de la utilidad neta. Si bien la cartera morosa alcanz√≥ un 3,2% en 2024, estimamos una progresiva mejora. Es clave destacar que el banco cuenta con s√≥lidos niveles de cobertura que le permiten absorber este riesgo, derivando en un costo por riesgo controlado que proyectamos mejorar√° desde 2026. Adicionalmente, avances tecnol√≥gicos como el nuevo sistema "Gravity" posicionan al banco como l√≠der en eficiencia operacional. La s√≥lida generaci√≥n de capital sustenta una atractiva pol√≠tica de dividendos (payout 60-70%).',
                driversPositivos: [
                    'Expansi√≥n de m√°rgenes (NIM) por escenario de tasas m√°s favorable.',
                    'Avances tecnol√≥gicos ("Gravity") que mejoran la eficiencia operacional.',
                    'S√≥lida generaci√≥n de capital y atractiva pol√≠tica de dividendos.'
                ],
                driversNegativos: [
                    'Evoluci√≥n del costo de cr√©dito asociado al escenario econ√≥mico y pol√≠tico.',
                    'Riesgo regulatorio que podr√≠a afectar el c√°lculo de requerimientos de capital.',
                    'Riesgos de mercado que desv√≠en los supuestos de valoraci√≥n.'
                ]
            },
            'LTM': {
                nombre: 'LATAM Airlines (LTM)',
                recomendacion: 'Sobreponderar',
                precioObjetivo: '$ 28 / acci√≥n',
                retorno: '39,4%',
                fuente: 'Booklet 2026',
                tesis: 'Mantenemos una visi√≥n positiva de la compa√±√≠a, principalmente por las perspectivas de crecimiento en oferta (ASK) para los pr√≥ximos a√±os, el plan de flota y los costos por asiento-kil√≥metro excluyendo combustible (CASK-ex fuel), que de mantenerse en niveles actuales continuar√°n agregando valor. La demanda se mantiene sana. La aerol√≠nea ha mostrado un favorable aumento en ASK (+8,22% acumulado a ago-2025), en l√≠nea con la regi√≥n. El segmento que ha empujado el crecimiento ha sido consistentemente Internacional (+10,55%). Proyectamos un precio de jet-fuel de USD 90/barril a largo plazo, y asumimos una leve mejora en consumo por la entrada de aeronaves m√°s eficientes. Adem√°s, se mantienen beneficios tributarios que continuar√≠an favoreciendo la √∫ltima l√≠nea.',
                driversPositivos: [
                    'Fuerte crecimiento en oferta (ASK), especialmente en el segmento internacional.',
                    'Demanda resiliente y CASK-ex fuel controlados.',
                    'Renovaci√≥n de flota con aeronaves m√°s eficientes.',
                    'Beneficios tributarios que favorecen la utilidad neta.'
                ],
                driversNegativos: [
                    'Imposici√≥n de aranceles por parte de EEUU a pa√≠ses latinoamericanos.',
                    'Depreciaci√≥n de monedas locales donde opera la compa√±√≠a.',
                    'Volatilidad en el precio del petr√≥leo y jet fuel.',
                    'Presiones en precio producto de futuras ventas secundarias de acciones.'
                ]
            },
            'SQM-B': {
                nombre: 'SQM (SQM-B)',
                recomendacion: 'Sobreponderar',
                precioObjetivo: '$ 51.000 / acci√≥n',
                retorno: '23,4%',
                fuente: 'Booklet 2026',
                tesis: 'El mercado del litio contin√∫a transitando por un exceso de oferta internacional, aunque las perspectivas de equilibrio han evolucionado favorablemente, mejorando la trayectoria de precios de corto plazo. La mejora en los precios se explica por cambios recientes en la producci√≥n y sus perspectivas. Conservadoramente, proyectamos precios realizados de litio promediando ~US$10,9/kg en 2026. Los vol√∫menes despachados de litio se ubicar√≠an en 230k ton en 2025, aumentando a 278k ton en 2026. Nuestro modelo considera un precio de largo plazo de US$13/kg. Prevemos una generaci√≥n de flujos moderada en 2025, pero con evoluci√≥n favorable desde el segundo semestre.',
                driversPositivos: [
                    'Mejora en las perspectivas de precio del litio.',
                    'Fuerte aumento en vol√∫menes de venta proyectados para 2026 (+21% a/a).',
                    'Certificaci√≥n IRMA 75, primera en el mundo en litio, generando ventaja competitiva.'
                ],
                driversNegativos: [
                    'Aceleraci√≥n de la ca√≠da de precios internacionales del Litio.',
                    'Modificaciones en el plan de inversiones de la compa√±√≠a.',
                    'Avances tecnol√≥gicos que impliquen menor uso de litio o riesgo de sustituci√≥n.'
                ]
            },
            'CENCOSUD': {
                nombre: 'Cencosud (CENCOSUD)',
                recomendacion: 'Sobreponderar',
                precioObjetivo: '$ 3.300 / acci√≥n',
                retorno: '21,3%',
                fuente: 'Booklet 2026',
                tesis: 'Estimamos que los pr√≥ximos a√±os ser√°n de rentabilizar y expandir operaciones en pa√≠ses claves como Chile, Estados Unidos y Brasil. Creemos que la acci√≥n se encuentra descontada en relaci√≥n a sus m√∫ltiplos hist√≥ricos, considerando la mejora en m√°rgenes y expansi√≥n. El segmento de supermercados (65% del Ebitda) permite una generaci√≥n de flujos m√°s estables. Incorporamos un plan de inversiones de aprox. US$500 millones para 2026, destinados a crecimiento, remodelaciones y tecnolog√≠a, fortaleciendo su posici√≥n competitiva. Mantenemos una visi√≥n conservadora para Argentina.',
                driversPositivos: [
                    'Foco en rentabilizar y expandir operaciones en mercados clave (EEUU, Brasil).',
                    'Segmento Supermercados (65% Ebitda) aporta flujos estables y resilientes.',
                    'Plan de inversiones para remodelaci√≥n y tecnolog√≠a.',
                    'Plan de desapalancamiento y estrategia de rentabilizar operaci√≥n.'
                ],
                driversNegativos: [
                    'Debilidad del consumo discrecional superior a la estimada.',
                    'Desviaciones en el plan de inversiones o su rentabilidad.',
                    'Depreciaci√≥n de monedas locales (Argentina, Per√∫, etc.).',
                    'Aparici√≥n de nuevos competidores internacionales con foco en e-commerce.'
                ]
            },
            'CENCOMALLS': {
                nombre: 'Cenco Malls (CENCOMALLS)',
                recomendacion: 'Sobreponderar',
                precioObjetivo: '$ 2.450 / acci√≥n',
                retorno: '24,6%',
                fuente: 'Booklet 2026',
                tesis: 'La compa√±√≠a posee un alto porcentaje de contratos con alto componente fijo, indexados a inflaci√≥n y contratos de largo plazo con locatarios, que generar√≠an estabilidad en flujos. Durante el 1S25 las visitas aumentaron un 1,9% a/a y el nivel de ocupaci√≥n lleg√≥ a 98,5%. Los crecimientos de GLA vendr√°n por remodelaciones y ampliaciones, destacando Cenco La Molina en Per√∫. Se busca potenciar el uso mixto, que hoy representa un 16,8% del GLA.',
                driversPositivos: [
                    'Contratos fijos de largo plazo indexados a inflaci√≥n (UF).',
                    'Altos y crecientes niveles de ocupaci√≥n (98,5%).',
                    'Desarrollo de nuevos proyectos (Per√∫) y expansi√≥n de uso mixto.'
                ],
                driversNegativos: [
                    'Evoluci√≥n de la econom√≠a (consumo) diferente a lo esperado.',
                    'Alta exposici√≥n a ingresos provenientes de parte relacionada (Cencosud S.A.).',
                    'Nuevas reformas tributarias en los pa√≠ses donde opera.'
                ]
            },
            'AGUAS-A': {
                nombre: 'Aguas Andinas (AGUAS-A)',
                recomendacion: 'Neutral',
                precioObjetivo: '$ 400 / acci√≥n',
                retorno: '17,4%',
                fuente: 'Booklet 2026',
                tesis: 'La compa√±√≠a se encuentra en fase de ejecuci√≥n de obras (plan Biociudad), lo que junto a las tarifas aprobadas para este quinquenio impulsar√≠an un margen EBITDA a niveles de 55% hacia 2030. El costo de la deuda ha disminuido, ubicando el WACC en 7,4%. Las tarifas ajustadas para enfrentar el estr√©s h√≠drico otorgan certidumbre en la rentabilidad futura, lo que se traduce en una recuperaci√≥n sostenida de m√°rgenes.',
                driversPositivos: [
                    'Nuevas tarifas (octavo proceso) otorgan certidumbre y mejoran m√°rgenes.',
                    'Plan de inversiones (Biociudad) para mitigar riesgo h√≠drico.',
                    'Disminuci√≥n en el costo de deuda (WACC 7.4%).'
                ],
                driversNegativos: [
                    'Fen√≥menos climatol√≥gicos (turbiedad, sequ√≠a) que afecten la operaci√≥n.',
                    'Presiones inflacionarias y tasas de inter√©s elevadas.',
                    'Permisolog√≠a m√°s exigente por parte del regulador.'
                ]
            }
        };
        
        // INPUT 4: Definici√≥n de las Estrategias (para Secci√≥n 1.5)
        const modelosEstrategia = {
            'tactico': {
                nombre: "Agresivo (T√°ctico)",
                modelo: portafoliosBCI.tactico.composicion,
                activosClave: ['LTM', 'SQM-B', 'CENCOSUD'] // Key stocks for this model
            },
            'fundamental': {
                nombre: "Agresivo (Fundamental)",
                modelo: portafoliosBCI.fundamental.composicion,
                activosClave: ['BSANTANDER', 'LTM', 'CENCOMALLS']
            },
            'dividendos': {
                nombre: "Moderado (Dividendos)",
                modelo: portafoliosBCI.dividendos.composicion,
                activosClave: ['BSANTANDER', 'CENCOMALLS', 'AGUAS-A']
            }
        };

        // --- 2. VARIABLES GLOBALES Y UTILIDADES ---

        let modeloRecomendado = []; // Se setea en setEstrategia()
        let chartActual = null;
        let chartObjetivo = null;

        // Registrar el plugin de datalabels globalmente
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = 'Arial';
        Chart.defaults.plugins.datalabels.color = '#fff';
        Chart.defaults.plugins.datalabels.font = { weight: 'bold', size: 12 };
        Chart.defaults.plugins.datalabels.formatter = (value, ctx) => {
            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            let percentage = (value * 100 / sum).toFixed(1) + '%';
            return (value / sum) > 0.03 ? percentage : ''; // Solo mostrar si es > 3%
        };

        function formatCLP(value) {
            if (isNaN(value)) value = 0;
            return '$' + Math.round(value).toLocaleString('es-CL');
        }

        function formatPct(value) {
            if (isNaN(value) || value === Infinity) value = 0;
            return (value * 100).toLocaleString('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
        }

        // --- 3. L√ìGICA DE INICIALIZACI√ìN ---

        document.addEventListener('DOMContentLoaded', () => {
            initSimulador();
            initStrategySelector();
            initListeners();
            setEstrategia('tactico'); // Set default strategy on load
        });

        /**
         * Puebla las tablas iniciales del simulador (Sec 1 y 3).
         */
        function initSimulador() {
            // Puebla Secci√≥n 1: Cartera Actual
            const tablaDesinversionBody = document.querySelector('#tabla-desinversion tbody');
            tablaDesinversionBody.innerHTML = '';
            if (carteraActual.length === 0) {
                 tablaDesinversionBody.innerHTML = '<tr><td colspan="5" style="text-align: center; font-style: italic;">No hay activos en la cartera actual. Ingrese un "Aporte de Capital Nuevo" para comenzar.</td></tr>';
            } else {
                carteraActual.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.sector}</td>
                        <td>${item.activo}</td>
                        <td class="text-right">${formatCLP(item.monto)}</td>
                        <td class="text-center">
                            <label class="decision-label"><input type="radio" name="decision-${index}" class="decision-radio" value="rechazar" data-index="${index}" checked> Rechazar</label>
                            <label class="decision-label"><input type="radio" name="decision-${index}" class="decision-radio" value="aceptar" data-index="${index}"> Aceptar Total</label>
                            <label class="decision-label"><input type="radio" name="decision-${index}" class="decision-radio" value="parcial" data-index="${index}"> Parcial</label>
                            <input type="number" class="monto-parcial-input" id="monto-parcial-${index}" data-index="${index}" value="0" style="display: none;">
                        </td>
                        <td class="text-right" id="monto-liberar-${index}">$0</td>
                    `;
                    tablaDesinversionBody.appendChild(row);
                });
            }

            // Puebla Secci√≥n 3: Portafolios BCI
            const tablaPortafoliosBody = document.querySelector('#tabla-portafolios tbody');
            tablaPortafoliosBody.innerHTML = '';
            Object.values(portafoliosBCI).forEach(portfolio => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="adp-checkbox" data-id="${portfolio.id}"></td>
                    <td>${portfolio.nombre}</td>
                    <td>${portfolio.perfil}</td>
                    <td class="text-right">${portfolio.ytd.toLocaleString('es-CL')}%</td>
                    <td class="text-right">
                        <input type="number" class="adp-monto" id="monto-adp-${portfolio.id}" data-id="${portfolio.id}" value="0" min="0" step="1000000" disabled>
                    </td>
                `;
                tablaPortafoliosBody.appendChild(row);
            });
        }
        
        /**
         * Crea los botones de la Secci√≥n 1.5.
         */
        function initStrategySelector() {
            const container = document.getElementById('strategy-selector');
            container.innerHTML = '';
            Object.keys(modelosEstrategia).forEach(id => {
                const button = document.createElement('button');
                button.className = 'strategy-button';
                button.id = `btn-strategy-${id}`;
                button.dataset.id = id;
                button.textContent = modelosEstrategia[id].nombre;
                button.addEventListener('click', (e) => setEstrategia(e.target.dataset.id));
                container.appendChild(button);
            });
        }

        /**
         * A√±ade todos los event listeners para la interactividad.
         */
        function initListeners() {
            // Secci√≥n 1: Decisiones de Venta (si existen)
            document.querySelectorAll('.decision-radio').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const montoParcialInput = document.getElementById(`monto-parcial-${index}`);
                    montoParcialInput.style.display = (e.target.value === 'parcial') ? 'inline-block' : 'none';
                    updatePropuesta();
                });
            });
            document.querySelectorAll('.monto-parcial-input').forEach(input => {
                input.addEventListener('input', updatePropuesta);
            });

            // Secci√≥n 1: Aporte de Capital Nuevo
            document.getElementById('aporte-capital-nuevo').addEventListener('input', updatePropuesta);

            // Secci√≥n 3: Checkboxes y Montos de Portafolios
            document.querySelectorAll('.adp-checkbox').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const montoInput = document.getElementById(`monto-adp-${id}`);
                    montoInput.disabled = !e.target.checked;
                    if (!e.target.checked) {
                        montoInput.value = 0;
                    }
                    updatePortfolioDisplay();
                    updatePropuesta();
                });
            });
            document.querySelectorAll('.adp-monto').forEach(input => {
                input.addEventListener('input', updatePropuesta);
            });
            
            // Secci√≥n 3: Toggle Invertir en Modelo
            document.getElementById('toggle-modelo-acciones').addEventListener('change', (e) => {
                const container = document.getElementById('ponderacion-acciones-container');
                container.style.display = e.target.checked ? 'block' : 'none';
                updatePropuesta();
            });

            // Secci√≥n 5: Bot√≥n Imprimir
            document.getElementById('print-button').addEventListener('click', () => {
                window.print();
            });
        }

        // --- 4. L√ìGICA CENTRAL DE C√ÅLCULO Y RENDER ---

        /**
         * Define la estrategia de acciones a utilizar.
         * @param {string} id - El ID de la estrategia (ej: 'tactico').
         */
        function setEstrategia(id) {
            // 1. Actualizar estilo de botones
            document.querySelectorAll('.strategy-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.id === id);
            });
            
            // 2. Setear el modelo recomendado global
            modeloRecomendado = modelosEstrategia[id].modelo;
            
            // 3. Renderizar din√°micamente la Secci√≥n 2
            renderAnalisisClave(modelosEstrategia[id].activosClave);
            
            // 4. Renderizar din√°micamente la tabla de ponderaci√≥n (Sec 3)
            renderPonderacionAcciones(modeloRecomendado);
            
            // 5. Recalcular toda la propuesta
            updatePropuesta();
        }
        
        /**
         * Puebla din√°micamente la Secci√≥n 2 con el an√°lisis fundamental.
         * @param {string[]} activosClave - Array de IDs de activos (ej: ['LTM', 'SQM-B']).
         */
        function renderAnalisisClave(activosClave) {
            const container = document.getElementById('analisis-dinamico-container');
            container.innerHTML = '';
            
            activosClave.forEach(id => {
                const data = analisisActivosClave[id];
                if (!data) {
                    console.warn(`No se encontr√≥ an√°lisis para ${id}`);
                    return;
                }
                
                const html = `
                <div class="analysis-container">
                    <h3>${data.nombre}</h3>
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th>Recomendaci√≥n</th>
                                <th>Precio Objetivo 2026E</th>
                                <th>Retorno Total Esperado</th>
                                <th>Fuente</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${data.recomendacion}</td>
                                <td>${data.precioObjetivo}</td>
                                <td>${data.retorno}</td>
                                <td>${data.fuente}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="analysis-box">
                        <div class="analysis-justificacion">
                            <strong>Tesis de Inversi√≥n:</strong> ${data.tesis}
                            <br><cite>Fuente: Booklet Recomendaciones Burs√°tiles 2026.</cite>
                        </div>
                        <div class="analysis-drivers">
                            <div class="drivers-box drivers-positivo">
                                <h5>Drivers Positivos</h5>
                                <ul>${data.driversPositivos.map(d => `<li>${d}</li>`).join('')}</ul>
                            </div>
                            <div class="drivers-box drivers-negativo">
                                <h5>Drivers Negativos / Riesgos</h5>
                                <ul>${data.driversNegativos.map(d => `<li>${d}</li>`).join('')}</ul>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        /**
         * Puebla la tabla de ponderaci√≥n en Secci√≥n 3 y a√±ade listeners.
         * @param {object[]} modelo - El array de composici√≥n del modelo.
         */
        function renderPonderacionAcciones(modelo) {
            const tbody = document.querySelector('#tabla-ponderacion-acciones tbody');
            tbody.innerHTML = '';
            
            modelo.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.activo}</td>
                    <td>${item.categoria || item.sector}</td>
                    <td class="text-right">
                        <input type="number" class="peso-input" data-activo="${item.activo}" value="${item.peso * 100}" step="0.1" min="0"> %
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // A√±adir listeners a los nuevos inputs
            document.querySelectorAll('.peso-input').forEach(input => {
                input.addEventListener('input', () => {
                    updatePonderacionTotal();
                    updatePropuesta();
                });
            });
            
            updatePonderacionTotal();
        }
        
        /**
         * Calcula y muestra el total de los pesos en la tabla de ponderaci√≥n.
         */
        function updatePonderacionTotal() {
            let total = 0;
            document.querySelectorAll('.peso-input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const totalEl = document.getElementById('total-ponderacion-pct');
            totalEl.textContent = total.toLocaleString('es-CL', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
            
            if (Math.abs(total - 100) > 0.01) {
                totalEl.classList.add('invalid');
            } else {
                totalEl.classList.remove('invalid');
            }
        }


        /**
         * Funci√≥n principal que recalcula toda la propuesta.
         */
        function updatePropuesta() {
            // --- 4.1 C√ÅLCULOS (Secciones 1 y 3) ---

            let totalCapitalDisponible = 0;
            let totalVentas = 0;
            let origenFondos = [];

            // 1. Calcular Aporte de Capital Nuevo
            let aporteNuevo = parseFloat(document.getElementById('aporte-capital-nuevo').value) || 0;
            if (aporteNuevo > 0) {
                origenFondos.push({ 
                    fuente: "Aporte de Capital Nuevo", 
                    monto: aporteNuevo, 
                    cssClass: "new-buy" 
                });
            }
            totalCapitalDisponible += aporteNuevo;

            // 2. Calcular Ventas de Cartera Actual (Sec 1)
            let ventasAcciones = [];
            let mantenerAcciones = [];
            carteraActual.forEach((item, index) => {
                const decision = document.querySelector(`input[name="decision-${index}"]:checked`).value;
                const montoLiberarEl = document.getElementById(`monto-liberar-${index}`);
                let montoALiberar = 0;
                let montoAMantener = 0;

                if (decision === 'aceptar') {
                    montoALiberar = item.monto;
                    montoAMantener = 0;
                } else if (decision === 'parcial') {
                    let montoParcial = parseFloat(document.getElementById(`monto-parcial-${index}`).value) || 0;
                    if (montoParcial > item.monto) montoParcial = item.monto;
                    montoALiberar = montoParcial;
                    montoAMantener = item.monto - montoALiberar;
                } else { // 'rechazar'
                    montoALiberar = 0;
                    montoAMantener = item.monto;
                }

                montoLiberarEl.textContent = formatCLP(montoALiberar);
                totalVentas += montoALiberar;

                if (montoALiberar > 0) {
                    ventasAcciones.push({ ...item, ajuste: -montoALiberar, montoObjetivo: montoAMantener });
                    origenFondos.push({ 
                        fuente: `Venta ${item.activo}`, 
                        monto: montoALiberar, 
                        cssClass: "sell" 
                    });
                }
                if (montoAMantener > 0) {
                    mantenerAcciones.push({ ...item, ajuste: 0, montoObjetivo: montoAMantener });
                }
            });
            
            totalCapitalDisponible += totalVentas;
            document.getElementById('capital-liberado-monto').textContent = formatCLP(totalCapitalDisponible);

            // 3. Calcular Inversi√≥n en Portafolios (Sec 3)
            let totalMontoPortafolios = 0;
            let destinoPortafolios = [];
            let objetivoPortafolios = []; // Para Sec 4 y 5
            
            document.querySelectorAll('.adp-monto').forEach(input => {
                if (!input.disabled) {
                    totalMontoPortafolios += parseFloat(input.value) || 0;
                }
            });

            // 4. Validar Capital y Calcular Capital para Acciones
            const capitalWarningEl = document.getElementById('capital-warning');
            if (totalMontoPortafolios > totalCapitalDisponible) {
                totalMontoPortafolios = totalCapitalDisponible;
                capitalWarningEl.style.display = 'block';
                // Opcional: re-ajustar los inputs proporcionalmente (omitido por simplicidad)
            } else {
                capitalWarningEl.style.display = 'none';
            }

            let capitalParaAcciones = totalCapitalDisponible - totalMontoPortafolios;
            document.getElementById('capital-para-acciones-monto').textContent = formatCLP(capitalParaAcciones);

            // 5. Preparar datos de destino
            document.querySelectorAll('.adp-checkbox:checked').forEach(chk => {
                const id = chk.dataset.id;
                const portfolio = portafoliosBCI[id];
                let montoPortfolio = parseFloat(document.getElementById(`monto-adp-${id}`).value) || 0;
                
                // Re-distribuir si el total excedi√≥
                if (totalMontoPortafolios < (parseFloat(document.getElementById(`monto-adp-${id}`).value) || 0)) {
                    montoPortfolio = (montoPortfolio / totalMontoPortafolios) * totalCapitalDisponible; 
                }

                if (montoPortfolio > 0) {
                    const data = {
                        ...portfolio,
                        categoria: "Portafolios BCI",
                        activo: portfolio.nombre,
                        montoActual: 0,
                        ajuste: montoPortfolio,
                        montoObjetivo: montoPortfolio
                    };
                    destinoPortafolios.push({ 
                        fuente: portfolio.nombre, 
                        monto: montoPortfolio, 
                        cssClass: "buy" 
                    });
                    objetivoPortafolios.push(data);
                }
            });
            
            let destinoAccionesMonto = 0;
            let objetivoAcciones = []; // Para Sec 4 y 5
            const invertirEnModelo = document.getElementById('toggle-modelo-acciones').checked;
            
            if (capitalParaAcciones > 0 && invertirEnModelo) {
                destinoAccionesMonto = capitalParaAcciones;
                destinoPortafolios.push({ 
                    fuente: "Modelo Acciones Individuales", 
                    monto: capitalParaAcciones, 
                    cssClass: "buy" 
                });

                // Distribuir `capitalParaAcciones` seg√∫n los inputs de la tabla de ponderaci√≥n
                let pesosCustom = [];
                let totalPesosCustom = 0;
                document.querySelectorAll('.peso-input').forEach(input => {
                    const peso = parseFloat(input.value) || 0;
                    pesosCustom.push({
                        activo: input.dataset.activo,
                        peso: peso
                    });
                    totalPesosCustom += peso;
                });
                
                if (totalPesosCustom === 0) totalPesosCustom = 100; // Evitar divisi√≥n por cero

                pesosCustom.forEach(item => {
                    const montoCompra = capitalParaAcciones * (item.peso / totalPesosCustom);
                    // Encontrar la data completa de la acci√≥n
                    const dataOriginal = modeloRecomendado.find(m => m.activo === item.activo);
                    objetivoAcciones.push({
                        ...dataOriginal,
                        montoActual: 0,
                        ajuste: montoCompra,
                        montoObjetivo: montoCompra
                    });
                });

            } else if (capitalParaAcciones > 0 && !invertirEnModelo) {
                // El capital restante va a Caja
                const caja = { 
                    id: "caja", 
                    categoria: "Liquidez", 
                    activo: "Caja (No Asignado)", 
                    montoActual: 0, 
                    ajuste: capitalParaAcciones, 
                    montoObjetivo: capitalParaAcciones, 
                    composicion: [] 
                };
                objetivoPortafolios.push(caja);
                destinoPortafolios.push({ 
                    fuente: "Caja (No Asignado)", 
                    monto: capitalParaAcciones, 
                    cssClass: "new-buy" 
                });
            }

            // --- 4.2 GENERACI√ìN DE DATOS FINALES ---

            // Consolidar datos de Acciones (Mantener + Comprar)
            const accionesFinalMap = new Map();
            
            // 1. Agregar acciones a mantener
            mantenerAcciones.forEach(item => {
                accionesFinalMap.set(item.activo, {
                    ...item,
                    montoActual: item.monto,
                    ajuste: item.montoObjetivo - item.monto, // Ser√° 0 o negativo (venta parcial)
                    montoObjetivo: item.montoObjetivo
                });
            });

            // 2. Agregar acciones vendidas (parcialmente)
            ventasAcciones.forEach(item => {
                if (item.montoObjetivo > 0) { // Venta parcial
                    if (accionesFinalMap.has(item.activo)) {
                        let existing = accionesFinalMap.get(item.activo);
                        existing.ajuste = item.montoObjetivo - item.monto;
                        existing.montoObjetivo = item.montoObjetivo;
                    } else {
                        accionesFinalMap.set(item.activo, {
                            ...item,
                            montoActual: item.monto,
                            ajuste: item.montoObjetivo - item.monto,
                            montoObjetivo: item.montoObjetivo
                        });
                    }
                }
            });

            // 3. Agregar acciones compradas
            objetivoAcciones.forEach(item => {
                const montoCompra = item.montoObjetivo;
                if (accionesFinalMap.has(item.activo)) {
                    // Acci√≥n ya existe (se mantuvo o vendi√≥ parcialmente Y se compr√≥ m√°s)
                    let existing = accionesFinalMap.get(item.activo);
                    existing.ajuste += montoCompra;
                    existing.montoObjetivo += montoCompra;
                } else {
                    // Acci√≥n nueva
                    accionesFinalMap.set(item.activo, {
                        ...item,
                        montoActual: 0,
                        ajuste: montoCompra,
                        montoObjetivo: montoCompra
                    });
                }
            });

            // 4. Agregar acciones vendidas totalmente (para que aparezcan con monto 0)
            ventasAcciones.forEach(item => {
                if (item.montoObjetivo === 0 && !accionesFinalMap.has(item.activo)) {
                    accionesFinalMap.set(item.activo, {
                        ...item,
                        montoActual: item.monto,
                        ajuste: -item.monto,
                        montoObjetivo: 0
                    });
                }
            });

            const accionesFinal = Array.from(accionesFinalMap.values());
            const portafoliosFinal = objetivoPortafolios; // Ya est√° listo

            // --- 4.3 RENDERIZADO (Secciones 4 y 5) ---
            renderTablaFinal(accionesFinal, portafoliosFinal);
            renderResumenEjecutivo(origenFondos, destinoPortafolios, accionesFinal, portafoliosFinal, totalCapitalDisponible);
            updateCharts(accionesFinal, portafoliosFinal);
        }

        /**
         * Actualiza las tablas de la Secci√≥n 4.
         */
        function renderTablaFinal(accionesFinal, portafoliosFinal) {
            const tablaAccionesBody = document.querySelector('#tabla-final-acciones tbody');
            const tablaAdpBody = document.querySelector('#tabla-final-adp tbody');
            
            tablaAccionesBody.innerHTML = '';
            tablaAdpBody.innerHTML = '';

            let totalActual = 0;
            let totalObjetivo = 0;
            let accionesRendered = 0;

            // Render Acciones
            accionesFinal.forEach(item => {
                totalActual += item.montoActual;
                totalObjetivo += item.montoObjetivo;
                const ajusteClass = item.ajuste < 0 ? 'sell' : (item.montoActual > 0 ? 'buy' : 'new-buy');
                const pctAjuste = (item.montoActual > 0) ? (item.ajuste / item.montoActual) : (item.montoObjetivo > 0 ? Infinity : 0);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.categoria || 'N/A'}</td>
                    <td>${item.activo}</td>
                    <td class="text-right">${formatCLP(item.montoActual)}</td>
                    <td class="text-right ${ajusteClass}">${formatCLP(item.ajuste)}</td>
                    <td class="text-right ${ajusteClass}">${isFinite(pctAjuste) ? formatPct(pctAjuste) : 'N/A'}</td>
                    <td class="text-right">${formatCLP(item.montoObjetivo)}</td>
                `;
                if (item.montoObjetivo > 0 || item.montoActual > 0) {
                    tablaAccionesBody.appendChild(row);
                    accionesRendered++;
                }
            });
            if (accionesRendered === 0) {
                tablaAccionesBody.innerHTML = '<tr><td colspan="6" style="text-align: center; font-style: italic;">No hay acciones individuales en la propuesta.</td></tr>';
            }

            // Render Portafolios y Caja
            let portafoliosRendered = 0;
            portafoliosFinal.forEach(item => {
                totalActual += item.montoActual;
                totalObjetivo += item.montoObjetivo;
                const ajusteClass = 'new-buy';

                const row = document.createElement('tr');
                if (item.id === 'caja') {
                    row.classList.add('caja-row');
                } else {
                    row.classList.add('portfolio-row');
                }
                
                row.innerHTML = `
                    <td>${item.categoria}</td>
                    <td>${item.activo}</td>
                    <td class="text-right">${formatCLP(item.montoActual)}</td>
                    <td class="text-right ${ajusteClass}">${formatCLP(item.ajuste)}</td>
                    <td class="text-right ${ajusteClass}">N/A</td>
                    <td class="text-right">${formatCLP(item.montoObjetivo)}</td>
                `;
                tablaAdpBody.appendChild(row);
                portafoliosRendered++;

                // Detalle de composici√≥n del portafolio (si no es "Caja")
                if (item.composicion && item.composicion.length > 0) {
                    item.composicion.forEach(comp => {
                        const montoDetalle = item.montoObjetivo * comp.peso;
                        const rowDetail = document.createElement('tr');
                        rowDetail.classList.add('portfolio-detail-row');
                        rowDetail.innerHTML = `
                            <td></td>
                            <td>&nbsp;&nbsp;&nbsp;‚Ü≥ ${comp.activo}</td>
                            <td class="text-right">${formatCLP(0)}</td>
                            <td class="text-right ${ajusteClass}">${formatCLP(montoDetalle)}</td>
                            <td class="text-right ${ajusteClass}">(${formatPct(comp.peso)})</td>
                            <td class="text-right">${formatCLP(montoDetalle)}</td>
                        `;
                        tablaAdpBody.appendChild(rowDetail);
                    });
                }
            });
            if (portafoliosRendered === 0) {
                 tablaAdpBody.innerHTML = '<tr><td colspan="6" style="text-align: center; font-style: italic;">No se seleccionaron portafolios.</td></tr>';
            }
        }

        /**
         * Actualiza toda la Secci√≥n 5: Resumen Ejecutivo.
         */
        function renderResumenEjecutivo(origenFondos, destinoFondos, accionesFinal, portafoliosFinal, totalCapitalDisponible) {
            const origenUl = document.getElementById('origen-fondos');
            const destinoUl = document.getElementById('destino-fondos');
            const tablaResumenBody = document.querySelector('#ejecutivo-tabla-final tbody');
            const tablaResumenFoot = document.querySelector('#ejecutivo-tabla-final tfoot');

            origenUl.innerHTML = '';
            destinoUl.innerHTML = '';
            tablaResumenBody.innerHTML = '';
            tablaResumenFoot.innerHTML = '';

            let totalOrigen = 0;
            origenFondos.forEach(item => {
                totalOrigen += item.monto;
                origenUl.innerHTML += `
                    <li>
                        <span class="${item.cssClass}">${item.fuente}</span>
                        <span class="${item.cssClass}">${formatCLP(item.monto)}</span>
                    </li>`;
            });
            origenUl.innerHTML += `<li class="total"><span>Total Origen</span><span>${formatCLP(totalOrigen)}</span></li>`;

            let totalDestino = 0;
            destinoFondos.forEach(item => {
                totalDestino += item.monto;
                destinoUl.innerHTML += `
                    <li>
                        <span class="${item.cssClass}">${item.fuente}</span>
                        <span class="${item.cssClass}">${formatCLP(item.monto)}</span>
                    </li>`;
            });
            destinoUl.innerHTML += `<li class="total"><span>Total Destino</span><span>${formatCLP(totalDestino)}</span></li>`;

            // Tabla Resumen Final
            let granTotalObjetivo = 0;
            
            const todosLosActivos = [...accionesFinal, ...portafoliosFinal];
            todosLosActivos.forEach(item => {
                granTotalObjetivo += item.montoObjetivo;
            });

            todosLosActivos.sort((a, b) => b.montoObjetivo - a.montoObjetivo);

            todosLosActivos.forEach(item => {
                if (item.montoObjetivo > 0) {
                    const pctCartera = (granTotalObjetivo > 0) ? (item.montoObjetivo / granTotalObjetivo) : 0;
                    const row = document.createElement('tr');
                    if(item.categoria === 'Portafolios BCI') {
                        row.classList.add('portfolio-row');
                    } else if (item.id === 'caja') {
                        row.classList.add('caja-row');
                    }
                    row.innerHTML = `
                        <td>${item.categoria || 'N/A'}</td>
                        <td>${item.activo}</td>
                        <td class="text-right">${formatCLP(item.montoObjetivo)}</td>
                        <td class="text-right">${formatPct(pctCartera)}</td>
                    `;
                    tablaResumenBody.appendChild(row);
                }
            });

            // Footer
            tablaResumenFoot.innerHTML = `
                <tr>
                    <td colspan="2"><strong>Total Cartera Objetivo</strong></td>
                    <td class="text-right"><strong>${formatCLP(granTotalObjetivo)}</strong></td>
                    <td class="text-right"><strong>${formatPct(1)}</strong></td>
                </tr>
            `;
        }

        /**
         * Actualiza los gr√°ficos (Dona) en la Secci√≥n 5.
         */
        function updateCharts(accionesFinal, portafoliosFinal) {
            const ctxActual = document.getElementById('grafico-actual').getContext('2d');
            const ctxObjetivo = document.getElementById('grafico-objetivo').getContext('2d');

            if (chartActual) chartActual.destroy();
            if (chartObjetivo) chartObjetivo.destroy();

            // --- Gr√°fico Cartera Actual ---
            const dataActual = {
                labels: carteraActual.length > 0 ? carteraActual.map(a => a.activo) : ['Sin Cartera Actual'],
                datasets: [{
                    data: carteraActual.length > 0 ? carteraActual.map(a => a.monto) : [1],
                    backgroundColor: carteraActual.length > 0 ? ['#002D5A', '#005FFF', '#00A1DF', '#6C757D', '#ADB5BD'] : ['#EEEEEE'],
                }]
            };
            chartActual = new Chart(ctxActual, {
                type: 'doughnut',
                data: dataActual,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: carteraActual.length > 0, position: 'bottom' },
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => carteraActual.length > 0 ? `${ctx.label}: ${formatCLP(ctx.raw)}` : 'N/A'
                            } 
                        },
                        datalabels: {
                            display: carteraActual.length > 0
                        }
                    }
                }
            });

            // --- Gr√°fico Cartera Objetivo ---
            // Agrupar acciones y portafolios
            const dataObjetivoMap = new Map();
            accionesFinal.forEach(item => {
                if (item.montoObjetivo > 0) {
                    dataObjetivoMap.set(item.activo, (dataObjetivoMap.get(item.activo) || 0) + item.montoObjetivo);
                }
            });
            portafoliosFinal.forEach(item => {
                if (item.montoObjetivo > 0) {
                    dataObjetivoMap.set(item.activo, (dataObjetivoMap.get(item.activo) || 0) + item.montoObjetivo);
                }
            });
            
            const hasDataObjetivo = dataObjetivoMap.size > 0;

            const dataObjetivo = {
                labels: hasDataObjetivo ? Array.from(dataObjetivoMap.keys()) : ['Sin Asignaci√≥n'],
                datasets: [{
                    data: hasDataObjetivo ? Array.from(dataObjetivoMap.values()) : [1],
                    backgroundColor: hasDataObjetivo ? ['#002D5A', '#005FFF', '#00A1DF', '#018749', '#FFC107', '#D00000', '#6C757D', '#ADB5BD', '#28A745', '#17A2B8'] : ['#EEEEEE'],
                }]
            };

            chartObjetivo = new Chart(ctxObjetivo, {
                type: 'doughnut',
                data: dataObjetivo,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: hasDataObjetivo, position: 'bottom' },
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => hasDataObjetivo ? `${ctx.label}: ${formatCLP(ctx.raw)}` : 'N/A'
                            } 
                        },
                        datalabels: {
                            display: hasDataObjetivo
                        }
                    }
                }
            });
        }
        
        /**
         * Muestra la descripci√≥n del portafolio seleccionado en la Secci√≥n 3.
         */
        function updatePortfolioDisplay() {
            const displayEl = document.getElementById('adp-info-display');
            let html = '';
            document.querySelectorAll('.adp-checkbox:checked').forEach(chk => {
                const id = chk.dataset.id;
                const p = portafoliosBCI[id];
                html += `
                    <div>
                        <strong>${p.nombre}:</strong> (YTD: ${p.ytd}%) ${p.descripcion}
                        <p><i>Composici√≥n: ${p.composicion.map(c => `${c.activo} (${formatPct(c.peso)})`).join(', ')}</i></p>
                    </div>`;
            });
            if (html === '') {
                html = '<p>Seleccione un portafolio para ver su descripci√≥n y composici√≥n principal.</p>';
            }
            displayEl.innerHTML = html;
        }

    </script>

</body>
</html>